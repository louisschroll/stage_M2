---
title: "Untitled"
author: "Louis Schroll"
date: "2024-02-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
load("~/stage_M2/1.data/all_seabirds_counts.rdata")
```


```{r}
library(tidyverse)
library(sf)
count_by_session <- function(data_obs, species){
  cbs <- data_obs %>% as_tibble() %>% 
    filter(nom_fr == species) %>% 
    group_by(session) %>% 
    count()
  
  tot <- data_obs %>% as_tibble() %>% 
    filter(session %in% cbs$session) %>% 
    group_by(session) %>% 
    count()
  
  cbs$prop <- round(cbs$n / tot$n * 100, 1)
  
  date_df <- data_obs %>% as_tibble() %>% group_by(session) %>% summarise(begin = min(date), end = max(date))

  return(full_join(date_df, cbs, by = join_by(session)))
}

migralion_obs$species_name <- NA
pelmed_obs$species_name <- NA
pnm_obs$species_name <- NA
samm_obs$species_name <- NA
```

## Yellow-legged Gull / Goeland leucophee

Presence: year-round 
Reproduction: from March to July

Split data:
  - During repro: migralion data, prenup sessions, Megaobs data, spring sessions
  - Outside repro: migralion data postnup sessions, Megaobs data autumn sessions, Pelmed data, SAMM data winter sessions

```{r}
species <- "goeland leucophee"
count_by_session(migralion_obs, species)
count_by_session(samm_obs, species)
count_by_session(pelmed_obs, species)
count_by_session(pnm_obs, species)
```

```{r}
split_periods <- function(data_obs, species, session_repro, session_HR){
  data_obs %>% 
    mutate(species_name = ifelse(session %in% session_repro & nom_fr == species, 
                                        paste0(str_replace(species, " ", "_"), "_R"),
                                       species_name)) %>% 
    mutate(species_name = ifelse(session %in% session_HR & nom_fr == species, 
                                        paste0(str_replace(species, " ", "_"), "_HR"),
                                       species_name))
}

migralion_obs <- split_periods(migralion_obs, species="goeland leucophee", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))

pnm_obs <- split_periods(pnm_obs, "goeland leucophee", 
              session_repro = c("2019_printemps", "2020_printemps", "2021_printemps"), 
              session_HR = c("2019_automne", "2020_automne"))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="goeland leucophee", "goeland_leucophee_HR", species_name))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "goeland leucophee",
                                                 "goeland_leucophee_HR", species_name))
```


## Small shearwaters / Petits puffins (Puffins des Baléares + Puffins yelkouan)

Presence: year-round for Yelkouan, and fo balearic
Reproduction: from March to July

Split data:
  - During repro: migralion data, prenup sessions, Megaobs data, spring sessions
  - Outside repro: migralion data postnup sessions, Megaobs data autumn sessions, Pelmed data, SAMM data winter sessions

```{r}
species <- "petit puffin"
count_by_session(migralion_obs, species)
count_by_session(samm_obs, species)
count_by_session(pelmed_obs, species)
count_by_session(pnm_obs, species)
```

```{r}
migralion_obs <- split_periods(migralion_obs, species="petit puffin", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))

pnm_obs <- split_periods(pnm_obs, "petit puffin", 
              session_repro = c("2019_printemps", "2020_printemps", "2021_printemps"), 
              session_HR = c("2019_automne", "2020_automne"))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="petit puffin", "petit_puffin_HR", species_name))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "petit puffin",
                                                 "petit_puffin_HR", species_name))
```


## Mouette pygmée

Presence: winter - spring
Repro :may to end of July
Keep data: Migralion, prenup sessions, SAMM, winter sessions

```{r}
species <- "mouette pygmee"
count_by_session(migralion_obs, species)
count_by_session(samm_obs, species)
count_by_session(pelmed_obs, species)
count_by_session(pnm_obs, species)
```

```{r}
samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "mouette pygmee",
                                                 "mouette_pygmee_HR", species_name))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(session %in% c("prenup_2022", "prenup_2023") 
                                                 & nom_fr == "mouette pygmee",
                                                 "mouette_pygmee_HR", species_name))
```


## Sandwich terns / Sternes caugek

Presence: y-round
Reproduction: mars-avril à juillet

Split data:
  - During repro: migralion, prenup sessions, Megaobs, spring sessions
  - Outside repro: migralion data postnup sessions, Megaobs data automn sessions, Pelmed data, SAMM all sessions

```{r}
species <- "sterne caugek"
count_by_session(migralion_obs, species)
count_by_session(samm_obs, species)
count_by_session(pelmed_obs, species)
count_by_session(pnm_obs, species)
```

```{r}
migralion_obs <- split_periods(migralion_obs, species="sterne caugek", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))

pnm_obs <- split_periods(pnm_obs, "sterne caugek", 
              session_repro = c("2019_printemps", "2020_printemps", "2021_printemps"), 
              session_HR = c("2019_automne", "2020_automne"))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="sterne caugek", "sterne_caugek_HR", species_name))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(nom_fr == "sterne caugek",
                                                 "sterne_caugek_HR", species_name))
```


## Mouette melano

Presence: 
Reproduction: 

Split data:
  - During repro: migralion prenup sessions, pelmed?
  - Outside repro: migralion data postnup sessions, Megaobs data automn sessions, Pelmed data, SAMM data winter sessions

```{r}
species <- "mouette melanocephale"
count_by_session(migralion_obs, species)
count_by_session(samm_obs, species)
count_by_session(pelmed_obs, species)
count_by_session(pnm_obs, species)
```


```{r}
# migralion_obs <- split_periods(migralion_obs, species="mouette melanocephale", 
#               session_repro = c("prenup_2022", "prenup_2023"), 
#               session_HR = c("postnup_2022", "postnup_2023"))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(nom_fr=="mouette melanocephale" 
                                                    & session %in% c("postnup_2022", "postnup_2023"), 
                                                    "mouette_melanocephale_HR", species_name))

pnm_obs <- pnm_obs %>% mutate(species_name = ifelse(nom_fr=="mouette melanocephale" 
                                                    & session %in% c("2019_automne", "2020_automne"), 
                                                    "mouette_melanocephale_HR", species_name))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="mouette melanocephale", "mouette_melanocephale_HR", species_name))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "mouette melanocephale",
                                                 "mouette_melanocephale_HR", species_name))
```