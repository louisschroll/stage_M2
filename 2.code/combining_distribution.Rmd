---
title: "Combining maps"
author: "Louis Schroll"
date: "2024-04-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
options(knitr.table.NA = "")
```

```{r}
local_path <- "~/stage_M2/"
library(readxl)
library(tidyverse)
library(patchwork)
library(sf)
library(kableExtra)

load(file = paste0(local_path, "3.results/grid_spOccupancy_results.RData"))
load(file = paste0(local_path, "3.results/prediction_grid/grid_nmix_all_sp.RData"))
load(file = paste0(local_path, "1.data/contour_golfe_du_lion.rdata"))
load(file = paste0(local_path, "1.data/wind_farm_boundaries.RData"))

wind_farm <- wind_farm %>% 
  mutate(zone_nb = 1:nrow(.)) %>% 
  mutate(zone_type = case_when(
    zone_nb %in% 1:3 ~ "Ferme pilote",
    zone_nb %in% 4:5 ~ "Initial Park Zones",
    zone_nb %in% 6:7 ~ "Potential zones",
  )) %>% 
  filter(!(zone_type == "Ferme pilote")) %>% 
  mutate(zone_nb = zone_nb - 3)

source(paste0(local_path, "2.code/func_combine_maps.R"))

score_df <- compute_risk_score(file_criteria_value = paste0(local_path,"6.source/indice_sensibilite_responsabilité.xlsx")) 

spOccupancy_res_grid <- spOccupancy_res_grid %>% 
  rename(mean_psi_labbe_HR = mean_psi_labbe,
         sd_psi_labbe_HR = sd_psi_labbe,
         mean_psi_oceanite_tempete_R = mean_psi_oceanite_tempete,
         sd_psi_oceanite_tempete_R = sd_psi_oceanite_tempete)

grid_risk_occ <- create_grid_risk(grid_result = spOccupancy_res_grid, 
                          score_df)

grid_nmix_all_sp <- grid_nmix_all_sp %>% 
  rename(mean_psi_labbe_HR = mean_psi_labbe,
         sd_psi_labbe_HR = sd_psi_labbe,
         mean_psi_oceanite_tempete_R = mean_psi_oceanite_tempete,
         sd_psi_oceanite_tempete_R = sd_psi_oceanite_tempete)

grid_risk_nmix <- create_grid_risk(grid_result = grid_nmix_all_sp, score_df)

grid_risk_nmix %>% as_tibble() %>% summary()
grid_risk_occ %>% as_tibble() %>% summary()

```


### Criteria used to compute risk :

Alt: estimated percentage of time flying at blade height

Man: Flight maneuverability

Ptf: Percentage of time spent flying

Noc: Nocturnal activity score

Dis: Sensibility score to disturbance by wind turbines, boats, helicopter

Spe: Habitat specialization score

CS: Conservation score (species status and importance of the area for the species)


```{r}
indice_sensibilite_responsabilité %>% 
  select(nom_francais, Alt, Man, Ptf, Noc, Dis, Spe, CS_summer, CS_winter) %>%
  kable(format = "markdown") %>%
  kable_styling()
```



### Vulnerabiliy

$$
Species \ vulnerability \ score = \frac{Alt + Man + Ptf + Noc}{4} \times \frac{Dis + Spe}{2} \times CS
$$

```{r}
score_df %>% 
  select(nom_fr, vul_furn_summer, vul_furn_winter) %>% #vul_mean_summer, vul_mean_winter, vul_maxi_summer, vul_maxi_winter,
  mutate(nom_fr = str_replace_all(string = nom_fr, pattern= "_", replacement = " ") %>% 
           str_to_sentence()) %>%
  kable(format = "markdown", 
        col.names = c("French name", "Summer", "Winter"),
        align = "c",
        caption = "Vulnerability score") %>%
  kable_styling() %>% 
  add_header_above(header = c(" " = 1, "Vulnerability" = 2))
```



#### Collision

$$
Collision \ risk \ score = \frac{Alt \times (Man + Ptf + Noc)}{3} \times CS
$$



```{r}
collision_df <- score_df %>% 
  select(nom_fr, collision_summer_10, collision_winter_10) %>% 
  mutate(nom_fr = str_replace_all(string = nom_fr, pattern= "_", replacement = " ") %>% 
           str_to_sentence(),
         collisison_average = rowMeans(select(., collision_summer_10, collision_winter_10)))

collision_df %>%
  kable(format = "markdown") %>%
  kable_styling()
```

#### Disturbance and displacements

$$
Displacement \ score = \frac{(Dis + Spe) \times CS}{10}
$$


```{r}
score_df %>% 
  select(nom_fr, displacement_summer_10, displacement_winter_10) %>% 
  mutate(nom_fr = str_replace_all(string = nom_fr, pattern= "_", replacement = " ") %>% 
           str_to_sentence(),
         collisison_average = rowMeans(select(., displacement_summer_10, displacement_winter_10))) %>%
  kable(format = "markdown") %>%
  kable_styling()
```


```{r, fig.height=5, fig.width=10}
plot_collision_summer <- plot_vulnerability_map(grid_vulnerability = grid_vulnerability,
                                   fill_with = "collision_summer",
                                   plot_title = "Collision risk summer")

plot_collision_winter <- plot_vulnerability_map(grid_vulnerability = grid_vulnerability,
                                   fill_with = "collision_winter",
                                   plot_title = "Collision risk winter")

plot_collision_all <- plot_vulnerability_map(grid_vulnerability = grid_vulnerability,
                                   fill_with = "collision_all",
                                   plot_title = "Collision risk average")

plot_displacement_summer <- plot_vulnerability_map(grid_vulnerability = grid_vulnerability,
                                   fill_with = "displacement_summer",
                                   plot_title = "Displacement risk summer")

plot_displacement_winter <- plot_vulnerability_map(grid_vulnerability = grid_vulnerability,
                                   fill_with = "displacement_winter",
                                   plot_title = "Displacement risk winter")

plot_displacement_all <- plot_vulnerability_map(grid_vulnerability = grid_vulnerability,
                                   fill_with = "displacement_all",
                                   plot_title = "Displacement risk average")
```


```{r, fig.height=5, fig.width=5}
# (plot_collision_summer | plot_collision_winter | plot_collision_all) /
#   (plot_displacement_summer | plot_displacement_winter | plot_displacement_all)  + 
#   plot_layout(guides = "collect") +
#   plot_annotation(
#     title = "Seabirds vulnerability to wind farms",
#     #caption = 'Source: Migralion project & PELMED 2017-2021',
#     theme = theme(
#       plot.title = element_text(size = 10,
#                                 face = "bold",
#                                 hjust = 0.5),
#       plot.subtitle = element_text(hjust = 0.5),
#       legend.position = "bottom", 
#     ))
```



```{r, fig.height=10, fig.width=6}
map_vul_summer_occ <- plot_vulnerability_map(grid_vulnerability = grid_risk_occ,
                                   fill_with = "vulnerability_summer",
                                   plot_title = "Summer")

map_vul_winter_occ <- plot_vulnerability_map(grid_vulnerability = grid_risk_occ,
                                   fill_with = "vulnerability_winter",
                                   plot_title = "Winter")

map_vul_avg_occ <- plot_vulnerability_map(grid_vulnerability = grid_risk_occ,
                                   fill_with = "vulnerability_average",
                                   plot_title = "Average")

map_vul_summer_nmix <- plot_vulnerability_map(grid_vulnerability = grid_risk_nmix,
                                   fill_with = "vulnerability_summer",
                                   plot_title = "Summer")

map_vul_winter_nmix <- plot_vulnerability_map(grid_vulnerability = grid_risk_nmix,
                                   fill_with = "vulnerability_winter",
                                   plot_title = "Winter")

map_vul_avg_nmix <- plot_vulnerability_map(grid_vulnerability = grid_risk_nmix,
                                   fill_with = "vulnerability_average",
                                   plot_title = "Average")

```


### Maps

```{r, fig.height=10, fig.width=9}

(plot_collision_summer | plot_collision_winter | plot_collision_all) /
  (plot_displacement_summer | plot_displacement_winter | plot_displacement_all) / 
  (plot_furness_summer | plot_furness_winter | plot_furness_all) /
  (plot_mean_summer | plot_mean_winter | plot_mean_all) /
  (plot_maxi_summer | plot_maxi_winter | plot_maxi_all) + 
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Seabirds vulnerability to wind farms",
    theme = theme(
      plot.title = element_text(size = 12,
                                face = "bold",
                                hjust = 0.5),
      legend.position = "bottom", 
    ))

```



# Map comparison of the results for the two methods

```{r}
grid_vulnerability <- grid_risk_nmix %>% 
  select(starts_with("vulnerability")) %>% 
  mutate(vulnerability_summer = c(scale(vulnerability_summer)),
         vulnerability_winter = (scale(vulnerability_winter)),
         vulnerability_average = c(scale(vulnerability_average))) %>%
  pivot_longer(starts_with("vulnerability"), names_to = "season") %>% 
  mutate(season = str_replace(string = season, pattern = "(.*?)vulnerability_(.*?)", "\\1"),
         season = paste0(toupper(substring(season, 1, 1)), substring(season, 2))) %>% 
  mutate(methods = "N-mixture") %>% 
  bind_rows(grid_risk_occ %>% 
              select(starts_with("vulnerability")) %>% 
              mutate(vulnerability_summer = c(scale(vulnerability_summer)),
                     vulnerability_winter = (scale(vulnerability_winter)),
                     vulnerability_average = c(scale(vulnerability_average))) %>%
              pivot_longer(starts_with("vulnerability"), names_to = "season") %>% 
              mutate(season = str_replace(string = season, pattern = "(.*?)vulnerability_(.*?)", "\\1"),
                     season = paste0(toupper(substring(season, 1, 1)), substring(season, 2))) %>% 
              mutate(methods = "Occupancy"))


legend_position = "right"
plot_title = ""
plot_title_size = 8
legend_title_size = 9
axis_text_size = 4
plot_font = "Arial"
wind_farm_color <- c("brown", "darkgreen")

map_risk <- 
  ggplot() +
  geom_sf(data = grid_vulnerability, aes(fill = value), color = NA, lwd = 0) +
  facet_grid(methods ~ factor(season, levels = c("Winter", "Summer", "Average"))) + #, switch = "y"
    scale_fill_distiller(palette = "Spectral", 
                         breaks = c(min(grid_vulnerability$value), max(grid_vulnerability$value)),
                         labels = c("Low", "High")) +
    geom_sf(data = contour_golfe, color = "black", fill = "antiquewhite") +
    geom_sf(data = wind_farm2, 
            aes(col = as.factor(zone_type)), fill = NA) +
    geom_sf_text(data = wind_farm2, aes(label = zone_nb, col = as.factor(zone_type)), size = 1.4) +
    scale_color_manual(values = wind_farm_color) +
    #geom_sf(data = wind_farm, fill = NA, col = "black") +
    labs(title = plot_title) +
    theme_bw() +
    theme(
      #text = element_text(family = plot_font),
      legend.position = legend_position,
      legend.title = element_blank(),
      plot.title = element_text(hjust = 0.5, 
                                face = "bold", 
                                size = plot_title_size),
      plot.title.position = 'plot',
      axis.title = element_blank(),
      axis.text = element_text(size = axis_text_size),
      strip.text = element_text(face = "bold", size = plot_title_size),
      strip.background = element_rect(fill = "white", linetype = "solid",
                                      color = "white", linewidth = 0.9),
      panel.background = element_rect(fill = "transparent", color = "black", linewidth = 0.9)
    ) +
    guides(
      fill = guide_colourbar(
        title = "Seabirds \n vulnerability",
        title.theme = element_text(
          face = "bold",
          size = legend_title_size * 0.75,
          # family = plot_font,
          hjust = 0.5),
        title.position = 'top',
        title.hjust = .5,
        ticks = FALSE,
        barwidth = unit(.4, 'lines'),
        barheight = unit(6, 'lines'),
        label.theme = element_text(size = legend_title_size * 0.65)),
      colour = "none")


```

```{r}
grid_risk_nmix$vul_avg_scaled <- c(scale(grid_risk_nmix$vulnerability_average))
grid_risk_occ$vul_avg_scaled <- c(scale(grid_risk_occ$vulnerability_average))

risk_by_zone <- sapply(st_intersects(wind_farm2, grid_risk_nmix), function(x){grid_risk_nmix$vul_avg_scaled[x]}) %>% 
  map(~{.x %>% as_tibble()}) %>% 
  bind_rows(.id = "Zone") %>% 
  mutate(zone_type = case_when(
    Zone %in% 1:2 ~ "Initial Park Zones",
    Zone %in% 3:4 ~ "Potential zones",
  )) %>% 
  mutate(method = "N-mixture") %>% 
  bind_rows(sapply(st_intersects(wind_farm2, grid_risk_occ), function(x){grid_risk_occ$vul_avg_scaled[x]}) %>% 
  map(~{.x %>% as_tibble()}) %>% 
  bind_rows(.id = "Zone") %>% 
  mutate(zone_type = case_when(
    Zone %in% 1:2 ~ "Initial Park Zones",
    Zone %in% 3:4 ~ "Potential zones",
  )) %>% 
  mutate(method = "Occupancy")) %>% 
  rename(Vulnerability = value)

boxplot_risk <- ggplot(data = risk_by_zone, aes(x = Zone, y = Vulnerability, color = zone_type)) +
  geom_boxplot(linewidth = 0.35) +
  facet_wrap(~method, scales = "fixed") +
  scale_color_manual(values = wind_farm_color) +
  geom_hline(yintercept = 0, color = "grey", linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "right",
        legend.title = element_blank(),
        #axis.text.y = element_blank(),
        axis.text = element_text(size = axis_text_size * 1.4),
        axis.title = element_text(size = axis_text_size * 1.8),
        legend.text = element_text(size = legend_title_size * 0.75),
      strip.text = element_text(face = "bold", size = plot_title_size),
      strip.background = element_rect(fill = "white", linetype = "solid",
                                      color = "white", linewidth = 0.9),
      panel.background = element_rect(fill = "transparent", color = "white", linewidth = 0.9)) +
  labs(y = "Relative vulnerability")

```


```{r, fig.width=8, fig.height=6.6}
map_risk / 
  (plot_spacer() + boxplot_risk + plot_spacer() +
     plot_layout(widths = unit(c(3, 12, 3), "cm"))) +
  plot_layout(heights = unit(c(8, 4), "cm")) +
  plot_annotation(tag_levels = "A") &
  theme(title = element_text(hjust = 0.5))
```

