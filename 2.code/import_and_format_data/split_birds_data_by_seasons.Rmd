---
title: "Split datasets repro / non-repro"
author: "Louis Schroll"
date: "2024-02-28"
output: 
  html_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = FALSE, warning = F)
```

```{r}
load("~/stage_M2/1.data/all_seabirds_counts.rdata")
```


```{r}
library(tidyverse)
library(knitr)
library(sf)

count_by_session <- function(data_obs, species){
  cbs <- data_obs %>% as_tibble() %>% 
    filter(nom_fr == species) %>% 
    group_by(session) %>% 
    count()
  
  tot <- data_obs %>% as_tibble() %>% 
    filter(session %in% cbs$session) %>% 
    group_by(session) %>% 
    count()
  
  cbs$proportion <- round(cbs$n / tot$n * 100, 1)
  
  date_df <- data_obs %>% as_tibble() %>% group_by(session) %>% summarise(begin = min(date), end = max(date))
  
  final_df <- full_join(date_df, cbs, by = join_by(session)) %>% 
    rename(count = n)
  return(final_df)
}

migralion_obs$species_name <- NA
pelmed_obs$species_name <- NA
pnm_obs$species_name <- NA
samm_obs$species_name <- NA
```


# PT 1

## Yellow-legged Gull / Goeland leucophee

Presence: year-round 

Reproduction: from March to July

**Split data:**

  - **During repro: migralion data, prenup sessions, Megaobs data, spring sessions, Pelmed**
  
  - **Outside repro: migralion data postnup sessions, Megaobs data autumn sessions, SAMM data winter sessions**

```{r}
species <- "goeland leucophee"

count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
split_periods <- function(data_obs, species, session_repro, session_HR){
  data_obs %>% 
    mutate(species_name = ifelse(session %in% session_repro & nom_fr == species, 
                                        paste0(str_replace(species, " ", "_"), "_R"),
                                       species_name)) %>% 
    mutate(species_name = ifelse(session %in% session_HR & nom_fr == species, 
                                        paste0(str_replace(species, " ", "_"), "_HR"),
                                       species_name))
}

migralion_obs <- split_periods(migralion_obs, species="goeland leucophee", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))

pnm_obs <- split_periods(pnm_obs, "goeland leucophee", 
              session_repro = c("2019_printemps", "2020_printemps", "2021_printemps"), 
              session_HR = c("2019_automne", "2020_automne"))

pelmed_obs <- split_periods(pelmed_obs, "goeland leucophee", 
              session_repro = c("2017","2018", "2019", "2021"), 
              session_HR = c(""))

# pelmed_obs <- pelmed_obs %>% 
#   mutate(species_name = ifelse(nom_fr=="goeland leucophee", "goeland_leucophee_R", species_name))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "goeland leucophee",
                                                 "goeland_leucophee_HR", species_name))
```


## Small shearwaters / Petits puffins

Presence: year-round for Yelkouan, and for balearic

Reproduction: from March to July

**Split data**:

  - **During repro: migralion data (?), prenup sessions, Megaobs data, spring sessions, Pelmed**
  
  - **Outside repro: migralion data postnup sessions, Megaobs data autumn sessions, SAMM data winter sessions**

```{r}
species <- "petit puffin"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
migralion_obs <- split_periods(migralion_obs, species="petit puffin", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))

pnm_obs <- split_periods(pnm_obs, "petit puffin", 
              session_repro = c("2019_printemps", "2020_printemps", "2021_printemps"), 
              session_HR = c("2019_automne", "2020_automne"))

pelmed_obs <- split_periods(pelmed_obs, "petit puffin", 
              session_repro = c("2017","2018", "2019", "2021"), 
              session_HR = c(""))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "petit puffin",
                                                 "petit_puffin_HR", species_name))
```


## Mouette pygmée

Presence: winter - spring

Repro :may to end of July

**Keep data: Migralion, prenup sessions, SAMM, winter sessions**

```{r}
species <- "mouette pygmee"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "mouette pygmee",
                                                 "mouette_pygmee_HR", species_name))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(session %in% c("prenup_2022", "prenup_2023") 
                                                 & nom_fr == "mouette pygmee",
                                                 "mouette_pygmee_HR", species_name))
```


## Sandwich terns / Sternes caugek

Presence: y-round

Reproduction: mars-avril à juillet

**Split data:**

  - **During repro: migralion, prenup sessions, Megaobs, spring sessions, Pelmed**
  
  - **Outside repro: migralion data postnup sessions, Megaobs data automn sessions, SAMM winter sessions**

```{r}
species <- "sterne caugek"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
migralion_obs <- split_periods(migralion_obs, species="sterne caugek", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))

pnm_obs <- split_periods(pnm_obs, "sterne caugek", 
              session_repro = c("2019_printemps", "2020_printemps", "2021_printemps"), 
              session_HR = c("2019_automne", "2020_automne"))

pelmed_obs <- split_periods(pelmed_obs, "sterne caugek", 
              session_repro = c("2017","2018", "2019", "2021"), 
              session_HR = c(""))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(nom_fr == "sterne caugek",
                                                 "sterne_caugek_HR", species_name))
```


## Mouette melano

Presence: y-round

Reproduction: mi-mars à début juillet

**Split data:**

  - **During repro: migralion prenup sessions, pelmed**
  
  - **Outside repro: migralion data postnup sessions, Megaobs data automn sessions, SAMM data winter sessions**

```{r}
species <- "mouette melanocephale"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```


```{r}
migralion_obs <- split_periods(migralion_obs, species="mouette melanocephale", 
              session_repro = c("prenup_2022", "prenup_2023"), 
              session_HR = c("postnup_2022", "postnup_2023"))


pnm_obs <- pnm_obs %>% mutate(species_name = ifelse(nom_fr=="mouette melanocephale" 
                                                    & session %in% c("2019_automne", "2020_automne"), 
                                                    "mouette_melanocephale_HR", species_name))

pelmed_obs <- split_periods(pelmed_obs, "mouette melanocephale", 
              session_repro = c("2017","2018", "2019", "2021"), 
              session_HR = c(""))

samm_obs <- samm_obs %>% mutate(species_name = ifelse(session %in% c("SAMM_1(1winter)", "SAMM_2(1winter)") 
                                                 & nom_fr == "mouette melanocephale",
                                                 "mouette_melanocephale_HR", species_name))
```



# PT 2

```{r}
# migralion_obs$species_name <- NA
# pelmed_obs$species_name <- NA
# pnm_obs$species_name <- NA
# samm_obs$species_name <- NA
```


## Scopoli's shearwater / Puffin de Scopoli

Presence: repro, puis hivernage au large

Reproduction: avril - mai à septembre-octobre

**Split data:**

  - **During repro: PNM printemps, PELMED, Migralion**
  
  - **Outside repro: nothing**


```{r}
species <- "puffin de scopoli"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
migralion_obs <- migralion_obs %>% 
  mutate(species_name = ifelse(nom_fr=="puffin de scopoli",
                               #& session %in% c("postnup_2022", "postnup_2023"),
                                                    "puffin_de_scopoli_R", species_name))
  # split_periods(migralion_obs, species="mouette melanocephale", 
  #             session_repro = c("prenup_2022", "prenup_2023"), 
  #             session_HR = c("postnup_2022", "postnup_2023"))


pnm_obs <- pnm_obs %>% mutate(species_name = ifelse(nom_fr=="puffin de scopoli" 
                                                    & session %in% c("2019_printemps", 
                                                                     "2020_printemps", 
                                                                     "2021_printemps"), 
                                                    "puffin_de_scopoli_R", species_name))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="puffin de scopoli",
                                                    "puffin_de_scopoli_R", species_name))

```

## Common tern / Sterne pierregarin

Hautement migratrice, la Sterne pierregarin quitte totalement ses sites de reproduction à partir de la mi-août et dans le courant du mois de septembre. A partir de la fin de l’été, des rassemblements importants d’oiseaux peuvent être notés sur le littoral, principalement vers la fin août et en début septembre. Quelques rares observations hivernales sont effectuées chaque année en France, concernant à chaque fois des individus isolés. 
Les premiers migrateurs arrivent en France de la fin mars au début du mois d’avril, les individus les plus précoces étant notés au début du mois de mars, voire dès la mi-février en Méditerranée et sur la façade atlantique. 

Presence: 

Reproduction: avril à juillet

**Split data:**

  - **During repro: Migralion prenup, PELMED sauf 2020**
  
  - **Outside repro: X**


```{r}
species <- "sterne pierregarin"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```


```{r}
pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="sterne pierregarin" 
                                                    & session != "2020", 
                                                    "sterne_pierregarin_R", species_name))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(nom_fr=="sterne pierregarin"
                                                    & session %in% c("prenup_2022", "prenup_2023"), 
                                                    "sterne_pierregarin_R", species_name))
```


## Storm petrel / Oceanite tempete

Presence: 

Reproduction: mai à fin juillet

**Split data:**

  - **During repro: PNM printemps, Pelmed sauf 2020, Migralion prenup**
  
  - **Outside repro: X**
  

```{r}
species <- "oceanite tempete"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
# samm_obs <- samm_obs %>% mutate(species_name = ifelse(nom_fr == "oceanite tempete"
#                                                       & session == "SAMM_1(2summer)",
#                                                  "oceanite_tempete", species_name))

pnm_obs <- pnm_obs %>% mutate(species_name = ifelse(nom_fr=="oceanite tempete", 
                                                    #& session %in% c("2019_automne", "2020_automne"), 
                                                    "oceanite_tempete", species_name))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="oceanite tempete" 
                                                    & session != "2020", 
                                                    "oceanite_tempete", species_name))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(nom_fr=="oceanite tempete"
                                                    & session %in% c("prenup_2022", "prenup_2023"), 
                                                    "oceanite_tempete", species_name))
```


## Black-headed gull / Mouette rieuse

Presence: 

Reproduction: 

**Split data:**

  - **During repro: X**
  
  - **Outside repro: PNM autumn, SAMM winter, migralion postnup**


```{r}
species <- "mouette rieuse"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```

```{r}
samm_obs <- samm_obs %>% mutate(species_name = ifelse(nom_fr == "mouette rieuse"
                                                      & session %in% c("SAMM_1(1winter)","SAMM_2(1winter)"),
                                                 "mouette_rieuse_HR", species_name))

pnm_obs <- pnm_obs %>% mutate(species_name = ifelse(nom_fr=="mouette rieuse" 
                                                    & session %in% c("2019_automne", "2020_automne"), 
                                                    "mouette_rieuse_HR", species_name))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(nom_fr=="mouette rieuse"
                                                    & session %in% c("prenup_2022", "prenup_2023"), 
                                                    "mouette_rieuse_HR", species_name))
```


## Northern gannet / Fou de bassan

Presence: 

Reproduction: 

**Split data:**

  - **During repro: **
  
  - **Outside repro: **


```{r}
species <- "fou de bassan"
count_by_session(migralion_obs, species) %>% kable(format = "markdown", caption = "Migralion")
count_by_session(samm_obs, species) %>% kable(format = "markdown", caption = "SAMM")
count_by_session(pelmed_obs, species) %>% kable(format = "markdown", caption = "Pelmed")
count_by_session(pnm_obs, species) %>% kable(format = "markdown", caption = "Megaobs - PNM")
```


```{r}
samm_obs <- samm_obs %>% mutate(species_name = ifelse(nom_fr == "fou de bassan",
                                                     # & session == "SAMM_1(2summer)",
                                                 "fou_de_bassan_HR", species_name))

pnm_obs <- pnm_obs %>% mutate(species_name = ifelse(nom_fr=="fou de bassan", 
                                                    #& session %in% c("2019_automne", "2020_automne"), 
                                                    "fou_de_bassan_HR", species_name))

pelmed_obs <- pelmed_obs %>% mutate(species_name = ifelse(nom_fr=="fou de bassan",
                                                    #& session != "2020", 
                                                    "fou_de_bassan_HR", species_name))

migralion_obs <- migralion_obs %>% mutate(species_name = ifelse(nom_fr=="fou de bassan"
                                                    & session %in% c("prenup_2022", "prenup_2023"), 
                                                    "fou_de_bassan_HR", species_name))
```


```{r}
save(pelmed_obs, pelmed_eff, 
     samm_obs, samm_eff, 
     pnm_obs, pnm_eff,
     migralion_obs, migralion_eff,
     ferme_obs, ferme_eff,
     file = "~/stage_M2/1.data/all_seabirds_counts.rdata")
```